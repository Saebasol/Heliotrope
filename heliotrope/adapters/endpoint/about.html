<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heliotrope</title>
    <script>
        let isMirroring = false;
        let mirroringStatus = {};
        let intervalId;

        async function fetchStatus() {
            const response = await fetch('/api/status');
            mirroringStatus = await response.json();
            if (!mirroringStatus.is_mirroring_galleryinfo && !mirroringStatus.is_converting_to_info && !mirroringStatus.is_checking_integrity) {
                isMirroring = false;
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
            } else {
                isMirroring = true;
                if (!intervalId) {
                    intervalId = setInterval(fetchStatus, 5000);
                }
            }
            updateStatus();
        }

        function updateStatus() {
            const statusElement = document.getElementById('status');
            const checkedElement = document.getElementById('checked');
            const lang = mirroringStatus.index_files.map(i => /index-(.+).nozomi/.exec(i)[1]).join(", ")
            if (mirroringStatus.is_mirroring_galleryinfo) {
                statusElement.innerText = `Currently mirroring  ${lang} Galleryinfo ...`;
                checkedElement.innerText = `I am mirroring ${mirroringStatus.total_items} works, and ${mirroringStatus.batch_completed} out of ${mirroringStatus.batch_total} jobs have been completed.`;
            } else if (mirroringStatus.is_converting_to_info) {
                statusElement.innerText = `Currently converting to ${lang} info`;
                checkedElement.innerText = `I am converting ${mirroringStatus.total_items} works, and ${mirroringStatus.batch_completed} out of ${mirroringStatus.batch_total} jobs have been completed.`;
            } else if (mirroringStatus.is_checking_integrity) {
                statusElement.innerText = `Currently checking integrity ${lang} galleryinfo`;
                checkedElement.innerText = `I am checking ${mirroringStatus.total_items} works, and ${mirroringStatus.batch_completed} out of ${mirroringStatus.batch_total} jobs have been completed.`;
            } else {
                statusElement.innerText = `Currently I'm idle and I ${mirroringStatus.items_processed} with the following languages: ${lang}`;
                if (mirroringStatus.items_processed === 0) {
                    checkedElement.innerText = `I last checked on ${mirroringStatus.last_checked_at} and no works have been ${mirroringStatus.items_processed} yet. were last ${mirroringStatus.items_processed} on ${mirroringStatus.last_mirrored_at}.`
                    return;
                }
                checkedElement.innerText = `I last checked on ${mirroringStatus.last_checked_at} and ${mirroringStatus.items_processed} works were last ${mirroringStatus.items_processed} on ${mirroringStatus.last_mirrored_at}.`
            }
        }

        // Initial fetch
        fetchStatus();
    </script>
</head>

<body style="text-align: center;">
    <h1>Heliotrope</h1>
    <h2 id="status"></h2>
    <h3 id="checked"></h3>
</body>

</html>